# ==============================================================
# StarForge TX Machina — Fly-D7 + Pi-Lite
# TMC2209 (UART), NPN Inductive Z-Probe on PA10 (active-low)
# Production-Ready / G28 centers before Z probe (safe_z_home)
# ==============================================================

# -------- MCU link --------
[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f072xb_3E0032001057435633333820-if00

# -------- Printer kinematics & limits --------
[printer]
kinematics: corexy
max_velocity: 300
max_accel: 4000
max_z_velocity: 20
max_z_accel: 80
square_corner_velocity: 5.0

# -------- X Axis --------
[stepper_x]
step_pin: PA1
dir_pin: !PA0
enable_pin: !PA2
microsteps: 16
rotation_distance: 40
endstop_pin: tmc2209_stepper_x:virtual_endstop
position_endstop: 0
position_min: 0
position_max: 235
homing_speed: 50
homing_retract_dist: 10

[tmc2209 stepper_x]
uart_pin: PC3
run_current: 0.80
hold_current: 0.50
stealthchop_threshold: 0
diag_pin: PD2
driver_SGTHRS: 80

# -------- Y Axis --------
[stepper_y]
step_pin: PC14
dir_pin: !PC13
enable_pin: !PC15
microsteps: 16
rotation_distance: 40
endstop_pin: tmc2209_stepper_y:virtual_endstop
position_endstop: 0
position_min: 0
position_max: 235
homing_speed: 50
homing_retract_dist: 10

[tmc2209 stepper_y]
uart_pin: PB7
run_current: 0.80
hold_current: 0.50
stealthchop_threshold: 0
diag_pin: PB3
driver_SGTHRS: 80

# -------- Z Axis (homes with probe) --------
[stepper_z]
step_pin: PA5
dir_pin: !PA4
enable_pin: !PA6
microsteps: 16
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop
position_min: -60
position_max: 250
homing_speed: 6
homing_retract_dist: 10

[tmc2209 stepper_z]
uart_pin: PA3
run_current: 0.90
hold_current: 0.60
stealthchop_threshold: 0
diag_pin: PA9


# -------- Z1 (second Z motor) --------
[stepper_z1]
step_pin: PB10
dir_pin: !PB2
enable_pin: !PB11
microsteps: 16
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop

[tmc2209 stepper_z1]
uart_pin: PB1
run_current: 0.90
hold_current: 0.60
stealthchop_threshold: 0

# -------- Inductive Probe (NPN, active-low) --------
# PA10 is pulled up; sensor pulls LOW when it sees metal.
[probe]
pin: PA10
x_offset: 0
y_offset: 0
z_offset: 12.00          # probe fires ~12 mm above bed → set this value
speed: 3.0
lift_speed: 10.0
samples: 3
samples_result: median
samples_tolerance: 9999
samples_tolerance_retries: 0
sample_retract_dist: 12.0  # lift high enough to clear the field

# -------- Safe Z Home (center the probe before Z) --------
[safe_z_home]
home_xy_position: 67, 143
z_hop: 12
z_hop_speed: 10

[z_tilt]
z_positions:
   -27.9, 108.75
   247.9, 108.75
points:
   0,143
   165,143
speed: 130
horizontal_move_z: 15
retries: 7
retry_tolerance: 0.05        # <- stop when sides differ by < 0.05 mm
# -------- Heated Bed --------
[heater_bed]
heater_pin: PC7
sensor_pin: PC0
sensor_type: EPCOS 100K B57560G104F
min_temp: -200
max_temp: 120
#control: pid
#pid_kp: 68.167
#pid_ki: 1.215
#pid_kd: 956.048

[extruder]
step_pin: PC5
dir_pin: !PC4        # <-- invert to reverse direction
enable_pin: !PB0
microsteps: 16
rotation_distance: 7.0
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PB12
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC2
min_temp: -200
max_temp: 300
min_extrude_temp: 170
pressure_advance: 0.03
# control: pid
# pid_kp: 23.472
# pid_ki: 1.283
# pid_kd: 107.382
max_power: 1.0       # <-- allow 100% heater PWM (see note below)

[tmc2209 extruder]
uart_pin: PA7
run_current: 1    # motor current in A (RMS). Increase if you need more torque.
hold_current: 0.50
diag_pin: PA9
driver_SGTHRS: 60

# -------- Z Tilt & Bed Mesh --------
[bed_mesh]
speed: 300
horizontal_move_z: 1
mesh_min: 3,3
mesh_max: 213,213
probe_count: 6,6
algorithm: lagrange
bicubic_tension: 0.035
mesh_pps: 5,5
move_check_distance: 3
split_delta_z: 0.01
fade_start: 1
fade_end: 10
[exclude_object]
# -------- Fans --------
[fan]                            # part cooling
pin: PC9

[heater_fan hotend_fan]          # heatsink fan
pin: PC8
heater: extruder
heater_temp: 50
fan_speed: 1.0

# -------- QoL / Fluidd requirements --------
[force_move]
enable_force_move: true

[display_status]
[pause_resume]

[virtual_sdcard]
path: ~/printer_data/gcodes

[idle_timeout]
timeout: 1800

# 1) Force the current spot to be exactly X=67, Y=143, Z=12 (no motion)
[gcode_macro SET_ORIGIN_67_143_Z]
description: Treat current location as X=67 Y=143 Z=12 (no movement)
gcode:
  SET_KINEMATIC_POSITION X=67 Y=143 Z=12
  M117 Origin set to (67,143,12)

# 2) Home X & Y only, then set Z=12 (do NOT home Z, do NOT change X/Y numbers)
[gcode_macro HomeXY_Z12]
description: G28 X/Y, then declare Z=12 without homing Z
gcode:
  G28 X Y
  SET_KINEMATIC_POSITION Z=12
  M117 XY homed; Z=12

# --- Generic helper: set kinematic position to any values (no motion) ---
# Usage examples:
#   SET_ORIGIN_HERE X=70 Y=140 Z=12
#   SET_ORIGIN_HERE Z=12         ; keep current X/Y numbers, just set Z
[gcode_macro SET_ORIGIN_HERE]
description: Directly set Klipper's internal X/Y/Z position (no motion)
gcode:
  {% set X = params.X|default(none) %}
  {% set Y = params.Y|default(none) %}
  {% set Z = params.Z|default(none) %}
  {% if X is not none or Y is not none or Z is not none %}
    SET_KINEMATIC_POSITION{ ' X=%s' % X if X is not none else '' }{ ' Y=%s' % Y if Y is not none else '' }{ ' Z=%s' % Z if Z is not none else '' }
  {% else %}
    { action_respond_info("SET_ORIGIN_HERE needs at least one of X/Y/Z") }
  {% endif %}

# ==============================================================
# Print Macros
# ==============================================================

[gcode_macro PRINT_START]
description: Start: home, tilt adjust, mesh, heat, prime
gcode:
  {% set BED = params.BED|default(60)|float %}
  {% set HOT = params.HOT|default(200)|float %}
  M117 Heating...
  M140 S{BED}
  M104 S{HOT}
  G90
  G28                      ; homes XY, moves to center, probes Z (safe_z_home)
  Z_TILT_ADJUST            ; level gantry first (your preference)
  BED_MESH_CLEAR
  BED_MESH_CALIBRATE
  M190 S{BED}
  M109 S{HOT}
  G92 E0
  G1 X10 Y10 Z0.3 F6000
  G1 X200 E10 F1200
  G92 E0
  M117 Printing...

[gcode_macro PRINT_END]
description: Safe end sequence
gcode:
  G91
  G1 E-2 F2100
  G1 Z5 F1200
  G90
  G1 X10 Y200 F6000
  TURN_OFF_HEATERS
  M106 S0
  M117 Print Complete

[gcode_macro CANCEL_PRINT]
description: Cancel the current print safely
rename_existing: CANCEL_PRINT_BASE
gcode:
  TURN_OFF_HEATERS
  M106 S0
  {% if printer.toolhead.homed_axes == "xyz" %}
    G91
    G1 Z10 F600
    G90
    G1 X0 Y0 F6000
  {% endif %}
  CANCEL_PRINT_BASE
  M117 Print Canceled

[gcode_macro PAUSE]
description: Pause print safely
rename_existing: PAUSE_BASE
gcode:
  PAUSE_BASE
  {% if printer.toolhead.homed_axes == "xyz" %}
    G91
    G1 Z10 F600
    G90
    G1 X{printer.toolhead.axis_maximum.x-5} Y{printer.toolhead.axis_maximum.y-5} F6000
  {% endif %}
  M117 Print Paused

[gcode_macro RESUME]
description: Resume print
rename_existing: RESUME_BASE
gcode:
  RESUME_BASE
  M117 Resuming Print

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 71.363
#*# pid_ki = 0.969
#*# pid_kd = 1313.977
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 36.758
#*# pid_ki = 2.952
#*# pid_kd = 114.409
