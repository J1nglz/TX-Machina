# Adaptive Mesh Learning System
# Uses variables.cfg to track calibration count
# Python script handles complex data aggregation

[save_variables]
filename: ~/printer_data/config/variables.cfg

[gcode_macro LEARNING_MESH_CALIBRATE]
description: Probe bed - data tracked automatically
gcode:
    {% set bed_temp = params.BED_TEMP|default(printer.heater_bed.target)|float %}
    
    RESPOND MSG="Learning Mesh: Calibrating at {bed_temp}°C..."
    BED_MESH_CALIBRATE
    
    # Increment counter
    {% set svv = printer.save_variables.variables %}
    {% set count = svv.mesh_cal_count|default(0)|int + 1 %}
    SAVE_VARIABLE VARIABLE=mesh_cal_count VALUE={count}
    
    RESPOND MSG="Learning Mesh: Complete! Total calibrations: {count}"
    RESPOND MSG="Mesh data saved for {bed_temp}°C"

[gcode_macro MESH_LEARNING_STATS]
description: Show calibration statistics
gcode:
    {% set svv = printer.save_variables.variables %}
    {% set count = svv.mesh_cal_count|default(0) %}
    
    RESPOND MSG="=== Mesh Learning Stats ==="
    RESPOND MSG="Total calibrations: {count}"
    RESPOND MSG=""
    RESPOND MSG="For detailed analysis:"
    RESPOND MSG="SSH: python3 ~/printer_data/config/mesh_learning_analyzer.py analyze"

[gcode_macro CLEAR_MESH_LEARNING]
description: Reset calibration counter
gcode:
    {% set confirm = params.CONFIRM|default("no") %}
    
    {% if confirm|lower == "yes" %}
        SAVE_VARIABLE VARIABLE=mesh_cal_count VALUE=0
        RESPOND MSG="Counter reset"
    {% else %}
        RESPOND MSG="Add CONFIRM=yes to confirm"
    {% endif %}
