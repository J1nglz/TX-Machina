# ========================================
# ADAPTIVE BED MESH SYSTEM
# Dynamic temperature-based mesh loading
# ========================================

[gcode_macro _ADAPTIVE_MESH_VARS]
variable_mesh_profiles: {}  # Dictionary to store mesh metadata
variable_current_mesh: ""
variable_bed_temp_tolerance: 5  # Temperature tolerance in °C
gcode:

# ----------------------------------------
# ADAPTIVE MESH - Uses KAMP for print area
# ----------------------------------------
[gcode_macro ADAPTIVE_MESH]
description: Run adaptive bed mesh for print area only
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(printer.heater_bed.target)|int %}
    
    # Check if we have a suitable mesh already loaded
    {% set loaded_mesh = printer["gcode_macro _ADAPTIVE_MESH_VARS"].current_mesh %}
    {% if loaded_mesh != "" %}
        RESPOND MSG="Using existing mesh: {loaded_mesh}"
    {% else %}
        # Try to load temperature-appropriate mesh
        _LOAD_MESH_FOR_TEMP BED_TEMP={BED_TEMP}
        
        # If no suitable mesh found, create adaptive mesh
        {% if printer["gcode_macro _ADAPTIVE_MESH_VARS"].current_mesh == "" %}
            RESPOND MSG="Creating new adaptive mesh for {BED_TEMP}°C"
            BED_MESH_CALIBRATE
        {% endif %}
    {% endif %}

# ----------------------------------------
# GENERATE HIGH RES MESH
# Creates detailed mesh for current temp
# ----------------------------------------
[gcode_macro GENERATE_HIGH_RES_MESH]
description: Generate high-resolution mesh at current bed temperature
gcode:
    {% set BED_TEMP = printer.heater_bed.target|int %}
    {% set MESH_NAME = "mesh_%dC"|format(BED_TEMP) %}
    
    RESPOND MSG="Generating high-res mesh for {BED_TEMP}°C..."
    RESPOND MSG="This will take several minutes..."
    
    # Run high-resolution mesh
    BED_MESH_CALIBRATE PROFILE={MESH_NAME}
    
    # Save the mesh
    SAVE_CONFIG
    
    RESPOND MSG="High-res mesh saved as {MESH_NAME}"

# ----------------------------------------
# BUILD MESH LIBRARY
# Generate meshes for common temperatures
# ----------------------------------------
[gcode_macro BUILD_MESH_LIBRARY]
description: Generate mesh profiles for common temperatures
gcode:
    {% set TEMPS = [25, 60, 80, 100, 110] %}  # Common bed temperatures
    
    RESPOND MSG="Starting mesh library generation..."
    RESPOND MSG="This will take 30+ minutes. Please wait..."
    
    {% for temp in TEMPS %}
        RESPOND MSG="========================================="
        RESPOND MSG="Heating bed to {temp}°C..."
        M190 S{temp}  # Heat and wait
        
        # Wait for thermal expansion to stabilize
        G4 P300000  # Wait 5 minutes
        
        RESPOND MSG="Generating mesh at {temp}°C..."
        GENERATE_HIGH_RES_MESH
        
        RESPOND MSG="Mesh for {temp}°C complete!"
    {% endfor %}
    
    # Cool down
    M140 S0
    RESPOND MSG="========================================="
    RESPOND MSG="Mesh library generation complete!"
    RESPOND MSG="Profiles created for: {TEMPS}"

# ----------------------------------------
# LOAD MESH FOR TEMPERATURE
# Find and load closest matching mesh
# ----------------------------------------
[gcode_macro _LOAD_MESH_FOR_TEMP]
gcode:
    {% set BED_TEMP = params.BED_TEMP|int %}
    {% set TOLERANCE = printer["gcode_macro _ADAPTIVE_MESH_VARS"].bed_temp_tolerance %}
    
    # Try to find exact match first
    {% set EXACT_MESH = "mesh_%dC"|format(BED_TEMP) %}
    {% if EXACT_MESH in printer.bed_mesh.profiles %}
        BED_MESH_PROFILE LOAD={EXACT_MESH}
        SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARS VARIABLE=current_mesh VALUE='"{EXACT_MESH}"'
        RESPOND MSG="Loaded exact mesh: {EXACT_MESH}"
    {% else %}
        # Find closest temperature mesh
        {% set closest_temp = namespace(value=0, diff=1000) %}
        {% for profile in printer.bed_mesh.profiles %}
            {% if profile.startswith("mesh_") %}
                {% set temp = profile.replace("mesh_", "").replace("C", "")|int %}
                {% set diff = (temp - BED_TEMP)|abs %}
                {% if diff < closest_temp.diff %}
                    {% set closest_temp.value = temp %}
                    {% set closest_temp.diff = diff %}
                {% endif %}
            {% endif %}
        {% endfor %}
        
        {% if closest_temp.diff <= TOLERANCE %}
            {% set CLOSEST_MESH = "mesh_%dC"|format(closest_temp.value) %}
            BED_MESH_PROFILE LOAD={CLOSEST_MESH}
            SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARS VARIABLE=current_mesh VALUE='"{CLOSEST_MESH}"'
            RESPOND MSG="Loaded closest mesh: {CLOSEST_MESH} (target: {BED_TEMP}°C)"
        {% else %}
            RESPOND MSG="No suitable mesh found for {BED_TEMP}°C"
        {% endif %}
    {% endif %}

# ----------------------------------------
# CLEAR CURRENT MESH
# ----------------------------------------
[gcode_macro CLEAR_MESH]
description: Clear currently loaded mesh
gcode:
    BED_MESH_CLEAR
    SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARS VARIABLE=current_mesh VALUE='""'
    RESPOND MSG="Bed mesh cleared"

# ----------------------------------------
# LIST AVAILABLE MESHES
# ----------------------------------------
[gcode_macro LIST_MESHES]
description: List all available bed mesh profiles
gcode:
    RESPOND MSG="Available bed mesh profiles:"
    {% for profile in printer.bed_mesh.profiles %}
        RESPOND MSG="  - {profile}"
    {% endfor %}
