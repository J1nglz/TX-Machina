# ========================================
# THERMAL BED INTERPOLATION SYSTEM
# 3D mesh interpolation: X, Y, Temperature
# Dynamically adjusts Z based on current bed temp
# ========================================

[gcode_macro _THERMAL_MESH_DATA]
# Stores mesh data at different temperatures for interpolation
variable_mesh_data: {}  # Format: {temp: {point_index: z_value}}
variable_reference_temp: 60  # Base temperature for measurements
variable_temps_calibrated: []  # List of calibrated temperatures
variable_mesh_resolution: [6, 6]  # Mesh grid size
variable_last_applied_temp: 0
variable_interpolation_enabled: True
gcode:

# ----------------------------------------
# BUILD THERMAL MESH LIBRARY
# Generates detailed meshes at multiple temperatures
# ----------------------------------------
[gcode_macro BUILD_THERMAL_MESH_LIBRARY]
description: Build comprehensive thermal expansion mesh library
gcode:
    {% set TEMPS = params.TEMPS|default("25,40,60,80,100,110")|string %}
    {% set TEMP_LIST = TEMPS.split(',') %}
    {% set SOAK_TIME = params.SOAK_TIME|default(300)|int %}  # 5 min soak
    
    RESPOND MSG="========================================="
    RESPOND MSG="THERMAL MESH LIBRARY GENERATION"
    RESPOND MSG="This will take {(TEMP_LIST|length * (SOAK_TIME/60 + 5))|int} minutes"
    RESPOND MSG="========================================="
    
    # Home if not homed
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28
    {% endif %}
    
    {% for temp_str in TEMP_LIST %}
        {% set temp = temp_str|int %}
        RESPOND MSG="========================================="
        RESPOND MSG="Phase {loop.index}/{TEMP_LIST|length}: {temp}°C"
        RESPOND MSG="========================================="
        
        # Heat bed to target
        RESPOND MSG="Heating bed to {temp}°C..."
        M190 S{temp}
        
        # Soak for thermal stabilization
        RESPOND MSG="Soaking for {SOAK_TIME/60}min for thermal expansion..."
        G4 P{SOAK_TIME * 1000}
        
        # Perform mesh calibration
        RESPOND MSG="Probing mesh at {temp}°C..."
        BED_MESH_CALIBRATE PROFILE=thermal_{temp}C
        
        # Store mesh data
        _STORE_THERMAL_MESH TEMP={temp}
        
        RESPOND MSG="Mesh at {temp}°C complete!"
    {% endfor %}
    
    # Cool down
    M140 S0
    RESPOND MSG="========================================="
    RESPOND MSG="THERMAL LIBRARY COMPLETE!"
    RESPOND MSG="Calibrated temperatures: {TEMPS}"
    RESPOND MSG="Use APPLY_THERMAL_MESH before prints"
    RESPOND MSG="========================================="
    
    # Save all profiles
    SAVE_CONFIG

# ----------------------------------------
# STORE THERMAL MESH DATA
# Extracts and stores mesh points from current profile
# ----------------------------------------
[gcode_macro _STORE_THERMAL_MESH]
gcode:
    {% set TEMP = params.TEMP|int %}
    {% set mesh = printer.bed_mesh.profiles["thermal_%dC"|format(TEMP)] %}
    
    {% if mesh %}
        # Store mesh data for interpolation
        {% set mesh_dict = {} %}
        {% for i in range(mesh.points|length) %}
            {% for j in range(mesh.points[i]|length) %}
                {% set point_key = "%d_%d"|format(i, j) %}
                {% set _ = mesh_dict.update({point_key: mesh.points[i][j]}) %}
            {% endfor %}
        {% endfor %}
        
        # Update stored data
        {% set current_data = printer["gcode_macro _THERMAL_MESH_DATA"].mesh_data %}
        {% set _ = current_data.update({TEMP: mesh_dict}) %}
        SET_GCODE_VARIABLE MACRO=_THERMAL_MESH_DATA VARIABLE=mesh_data VALUE="{current_data}"
        
        # Update calibrated temps list
        {% set temps = printer["gcode_macro _THERMAL_MESH_DATA"].temps_calibrated %}
        {% if TEMP not in temps %}
            {% set _ = temps.append(TEMP) %}
            SET_GCODE_VARIABLE MACRO=_THERMAL_MESH_DATA VARIABLE=temps_calibrated VALUE="{temps|sort}"
        {% endif %}
        
        RESPOND MSG="Stored thermal mesh data for {TEMP}°C"
    {% endif %}

# ----------------------------------------
# APPLY THERMAL MESH
# Loads/interpolates mesh based on current bed temp
# ----------------------------------------
[gcode_macro APPLY_THERMAL_MESH]
description: Apply temperature-interpolated bed mesh
gcode:
    {% set TARGET_TEMP = params.TEMP|default(printer.heater_bed.target)|int %}
    {% set temps = printer["gcode_macro _THERMAL_MESH_DATA"].temps_calibrated %}
    
    {% if temps|length == 0 %}
        RESPOND TYPE=error MSG="No thermal mesh data! Run BUILD_THERMAL_MESH_LIBRARY first"
        # Fall back to KAMP adaptive mesh
        RESPOND MSG="Falling back to adaptive mesh..."
        BED_MESH_CALIBRATE
    {% else %}
        # Find bracketing temperatures for interpolation
        {% set lower_temp = namespace(value=0) %}
        {% set upper_temp = namespace(value=999) %}
        
        {% for temp in temps %}
            {% if temp <= TARGET_TEMP and temp > lower_temp.value %}
                {% set lower_temp.value = temp %}
            {% endif %}
            {% if temp >= TARGET_TEMP and temp < upper_temp.value %}
                {% set upper_temp.value = temp %}
            {% endif %}
        {% endfor %}
        
        {% if lower_temp.value == TARGET_TEMP %}
            # Exact match found
            BED_MESH_PROFILE LOAD=thermal_{TARGET_TEMP}C
            RESPOND MSG="Loaded exact thermal mesh for {TARGET_TEMP}°C"
        {% elif lower_temp.value > 0 and upper_temp.value < 999 %}
            # Interpolate between two meshes
            RESPOND MSG="Interpolating mesh between {lower_temp.value}°C and {upper_temp.value}°C for target {TARGET_TEMP}°C"
            _INTERPOLATE_THERMAL_MESH LOWER={lower_temp.value} UPPER={upper_temp.value} TARGET={TARGET_TEMP}
        {% elif lower_temp.value > 0 %}
            # Use closest lower temp
            BED_MESH_PROFILE LOAD=thermal_{lower_temp.value}C
            RESPOND MSG="Using closest mesh: {lower_temp.value}°C (target: {TARGET_TEMP}°C)"
        {% elif upper_temp.value < 999 %}
            # Use closest upper temp
            BED_MESH_PROFILE LOAD=thermal_{upper_temp.value}C
            RESPOND MSG="Using closest mesh: {upper_temp.value}°C (target: {TARGET_TEMP}°C)"
        {% else %}
            RESPOND TYPE=error MSG="No suitable thermal mesh found"
            BED_MESH_CALIBRATE
        {% endif %}
        
        SET_GCODE_VARIABLE MACRO=_THERMAL_MESH_DATA VARIABLE=last_applied_temp VALUE={TARGET_TEMP}
    {% endif %}

# ----------------------------------------
# INTERPOLATE THERMAL MESH
# Creates interpolated mesh between two temperatures
# ----------------------------------------
[gcode_macro _INTERPOLATE_THERMAL_MESH]
gcode:
    {% set LOWER = params.LOWER|int %}
    {% set UPPER = params.UPPER|int %}
    {% set TARGET = params.TARGET|int %}
    
    # Calculate interpolation factor (0 to 1)
    {% set factor = (TARGET - LOWER) / (UPPER - LOWER) %}
    
    RESPOND MSG="Interpolation factor: {factor|round(3)}"
    
    # For now, load the closer mesh
    # Full interpolation requires custom Klipper module
    {% if factor < 0.5 %}
        BED_MESH_PROFILE LOAD=thermal_{LOWER}C
        RESPOND MSG="Loaded {LOWER}°C mesh (factor: {factor|round(3)})"
    {% else %}
        BED_MESH_PROFILE LOAD=thermal_{UPPER}C
        RESPOND MSG="Loaded {UPPER}°C mesh (factor: {factor|round(3)})"
    {% endif %}

# ----------------------------------------
# AUTO THERMAL MESH
# Automatically applies thermal mesh during print start
# ----------------------------------------
[gcode_macro AUTO_THERMAL_MESH]
description: Auto-apply thermal mesh before print
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(printer.heater_bed.target)|int %}
    
    {% if printer["gcode_macro _THERMAL_MESH_DATA"].interpolation_enabled %}
        RESPOND MSG="Applying thermal mesh for {BED_TEMP}°C..."
        APPLY_THERMAL_MESH TEMP={BED_TEMP}
    {% else %}
        RESPOND MSG="Thermal interpolation disabled, using adaptive mesh"
        BED_MESH_CALIBRATE
    {% endif %}

# ----------------------------------------
# THERMAL MESH STATUS
# Show current thermal mesh system status
# ----------------------------------------
[gcode_macro THERMAL_MESH_STATUS]
description: Display thermal mesh calibration status
gcode:
    {% set temps = printer["gcode_macro _THERMAL_MESH_DATA"].temps_calibrated %}
    {% set enabled = printer["gcode_macro _THERMAL_MESH_DATA"].interpolation_enabled %}
    {% set last_temp = printer["gcode_macro _THERMAL_MESH_DATA"].last_applied_temp %}
    
    RESPOND MSG="========================================="
    RESPOND MSG="THERMAL MESH STATUS"
    RESPOND MSG="========================================="
    RESPOND MSG="Interpolation enabled: {enabled}"
    RESPOND MSG="Last applied temp: {last_temp}°C"
    RESPOND MSG="Calibrated temps: {temps}"
    RESPOND MSG="Total profiles: {temps|length}"
    RESPOND MSG="========================================="

# ----------------------------------------
# TOGGLE THERMAL INTERPOLATION
# ----------------------------------------
[gcode_macro TOGGLE_THERMAL_INTERPOLATION]
description: Enable/disable thermal mesh interpolation
gcode:
    {% set current = printer["gcode_macro _THERMAL_MESH_DATA"].interpolation_enabled %}
    SET_GCODE_VARIABLE MACRO=_THERMAL_MESH_DATA VARIABLE=interpolation_enabled VALUE={not current}
    RESPOND MSG="Thermal interpolation: {'ENABLED' if not current else 'DISABLED'}"

# ----------------------------------------
# QUICK THERMAL CALIBRATION
# Faster calibration for common temps
# ----------------------------------------
[gcode_macro QUICK_THERMAL_CALIBRATION]
description: Quick calibration for PLA/PETG/ABS temps
gcode:
    BUILD_THERMAL_MESH_LIBRARY TEMPS="60,80,100,110" SOAK_TIME=180
