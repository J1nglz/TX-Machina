# ==============================================================
# StarForge TX Machina â€” Fly-D7 + Pi-Lite
# TMC2209 (UART), NPN Inductive Z-Probe on PA10 (active-low)
# Production-Ready / G28 centers before Z probe (safe_z_home)
# ==============================================================
[include shell_command.cfg]
[include KAMP/Configuration/KAMP_Settings.cfg]
[include KAMP/Configuration/Adaptive_Meshing.cfg]
[include KAMP/Configuration/Line_Purge.cfg]
[include KAMP/Configuration/Smart_Park.cfg]
# -------- MCU link --------
[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f072xb_3E0032001057435633333820-if00
#[mcu adxl]
#serial: /dev/serial/by-id/usb-Klipper_rp2040_E6647C7403466037-if00
#[adxl345]
#cs_pin: adxl:gpio9
#spi_software_sclk_pin: adxl:gpio10
#spi_software_mosi_pin: adxl:gpio11
#spi_software_miso_pin: adxl:gpio12
#axes_map: -x, -z, y
#[resonance_tester]
#accel_chip: adxl345
#probe_points:
#  120,120,20
[respond]
# -------- Printer kinematics & limits --------
[printer]
kinematics: corexy
max_velocity: 300
max_accel: 13000 ;x12,600 y 11,200
max_z_velocity: 20
max_z_accel: 80
square_corner_velocity: 10.0
# -------- X Axis (physical endstop on PA9, NC to GND) --------
[stepper_x]
step_pin: PA1
dir_pin: !PA0
enable_pin: !PA2
microsteps: 16
rotation_distance: 40
endstop_pin: ^PB3           # enable pull-up; start without invert
position_endstop: 0
position_min: 0
position_max: 235
homing_speed: 80
homing_retract_dist: 3
[tmc2209 stepper_x]
uart_pin: PC3
run_current: 1.10
hold_current: 0.75
stealthchop_threshold: 0
# NO diag_pin for physical endstop
interpolate: True
# -------- Y Axis (physical endstop on PD2, NC to GND) --------
[stepper_y]
step_pin: PC14
dir_pin: !PC13
enable_pin: !PC15
microsteps: 16
rotation_distance: 40
endstop_pin: ^PD2          # enable pull-up; start without invert
position_endstop: 0
position_min: 0
position_max: 235
homing_speed: 60
homing_retract_dist: 3
[tmc2209 stepper_y]
uart_pin: PB7
run_current: 1.10
hold_current: 0.75
stealthchop_threshold: 0
# NO diag_pin for physical endstop
interpolate: True
# -------- Z Axis (homes with probe) --------
[stepper_z]
step_pin: PA5
dir_pin: !PA4
enable_pin: !PA6
microsteps: 16
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop
position_min: -60
position_max: 250
homing_speed: 6
homing_retract_dist: 10
[tmc2209 stepper_z]
uart_pin: PA3
run_current: 0.75
hold_current: 0.5
stealthchop_threshold: 60
#diag_pin: PA9
interpolate: True
# -------- Z1 (second Z motor) --------
[stepper_z1]
step_pin: PB10
dir_pin: !PB2
enable_pin: !PB11
microsteps: 16
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop
[tmc2209 stepper_z1]
uart_pin: PB1
run_current: 0.75
hold_current: 0.5
stealthchop_threshold: 60
interpolate: True
# -------- Inductive Probe (NPN, active-low) --------
[probe]
pin: ^PA10
x_offset: 40
y_offset: 6
z_offset: 7.5 #Offset = 7.78, z=+2.17mm to get nozzle to touch plate so subtracting 2.17mm will make nozzle touch at z=0 
speed: 3.0
lift_speed: 10.0
samples: 3
samples_result: median
samples_tolerance: 9999
samples_tolerance_retries: 0
sample_retract_dist: 10.0
# -------- Safe Z Home --------
; Disable old safe_z_home (override will handle Z)
; [safe_z_home]
; home_xy_position: 67, 143
; z_hop: 10
; z_hop_speed: 10
[homing_override]
axes: xyz
set_position_z: 0
gcode:
  {% set doX = 'X' in params %}
  {% set doY = 'Y' in params %}
  {% set doZ = 'Z' in params %}
  # Always give Z some clearance before any XY moves
  G91
  G0 Z10 F2400
  G90
  {% if not doX and not doY and not doZ %}
    # Full home: enforce Y -> X -> Z
    G28 Y
    G91
    G0 Y5 F3000       # back off 5 mm from Y endstop
    G90
    G28 X
    G91
    G0 X5 F3000       # back off 5 mm from X endstop
    G90
    G0 X67 Y143 F6000 # move to Z-probe point
    G28 Z
    G91
    G0 Z5 F2400       # lift 5 mm after Z home
    G90
  {% else %}
    # Per-axis homes keep the same behavior
    {% if doY %}
      G28 Y
      G91
      G0 Y5 F3000
      G90
    {% endif %}
    {% if doX %}
      G28 X
      G91
      G0 X5 F3000
      G90
    {% endif %}
    {% if doZ %}
      G0 X67 Y143 F6000
      G28 Z
      G91
      G0 Z5 F2400
      G90
    {% endif %}
  {% endif %}
# -------- Heated Bed --------
[heater_bed]
heater_pin: PC7
sensor_pin: PC0
sensor_type: EPCOS 100K B57560G104F
min_temp: -200
max_temp: 120
control: pid
pid_kp: 73.033
pid_ki: 1.252
pid_kd: 1065.367
# -------- Extruder --------

# -------- Filament Runout Sensor --------
[filament_switch_sensor filament_sensor]
switch_pin: PA9  # Inverted logic, no pull-up
pause_on_runout: True
runout_gcode:
    M117 Filament Runout!
insert_gcode:
    M117 Filament Loaded
event_delay: 3.0
pause_delay: 0.5

[extruder]
step_pin: PC5
dir_pin: PC4
enable_pin: !PB0
microsteps: 16
rotation_distance: 4.4110
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PB12
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC2
min_temp: -200
max_temp: 300
min_extrude_temp: 170
pressure_advance: 0.03
max_extrude_cross_section: 5
max_extrude_only_distance: 120
control: pid
pid_kp: 19.746
pid_ki: 0.779
pid_kd: 125.143
max_power: 1.0
[tmc2209 extruder]
uart_pin: PA7
run_current: 1.0
hold_current: 0.50
#diag_pin: PA9
driver_SGTHRS: 60
interpolate: True
# -------- Z Tilt & Mesh --------
[z_tilt]
z_positions:
   -27.9, 108.75
   50, 108.75
points:
   20,143
   140,143
speed: 250
horizontal_move_z: 15
retries: 7
retry_tolerance: 0.02
[bed_mesh]
speed: 300
horizontal_move_z: 15
mesh_min: 40,6
mesh_max: 213,213
probe_count: 6,6
algorithm: lagrange
bicubic_tension: 0.035
mesh_pps: 5,5
move_check_distance: 3
split_delta_z: 0.01
fade_start: 1
fade_end: 10
[exclude_object]
# -------- Fans --------
[fan]
pin: PC9
[heater_fan hotend_fan]
pin: PC8
heater: extruder
heater_temp: 50
fan_speed: 1.0

[thermistor chamber_10k_b3950]
temperature1: 22.0
resistance1: 11480
temperature2: 47.4
resistance2: 4910
temperature3: 136.0
resistance3: 1176

[heater_generic chamber]
heater_pin: PA8
sensor_type: chamber_10k_b3950
sensor_pin: PC1
control: pid
pid_Kp: 10.0
pid_Ki: 0.10
pid_Kd: 100.0
max_power: 1.0
min_temp: -20
max_temp: 90

[verify_heater chamber]
# Allow the slow chamber loop to warm without tripping faults.
max_error: 600
check_gain_time: 900
hysteresis: 10
heating_gain: 1

# -------- QoL --------
[force_move]
enable_force_move: true
[display_status]
[pause_resume]
[virtual_sdcard]
path: ~/printer_data/gcodes
[idle_timeout]
timeout: 1800
# -------- Diagnostics --------
# -------- Print Macros --------
[gcode_macro PRINT_START]
description: Start print: home, tilt adjust, mesh, heat, prime
gcode:
  {% set BED = params.BED|default(60)|float %}
  {% set HOT = params.HOT|default(200)|float %}
  
  M117 Heating bed...
  G90
  G28
  Z_TILT_ADJUST
  
  # Heat bed to target
  M140 S{BED}
  M190 S{BED}
  
  # Heat nozzle to probing temp
  M104 S150
  M109 S150
  
  # Use native Klipper adaptive mesh (fast!)
  BED_MESH_CALIBRATE ADAPTIVE=1 ADAPTIVE_MARGIN=5
  
  # Heat nozzle to print temp
  M104 S{HOT}
  M109 S{HOT}
  
  # Purge and print
  LINE_PURGE
  M117 Printing...

[gcode_macro PRINT_END]
description: Safe end sequence
gcode:
  G91
  G1 E-2 F2100
  G1 Z5 F1200
  G90
  G1 X10 Y200 F6000
  TURN_OFF_HEATERS
  M106 S0
  M117 Print Complete
[gcode_macro CANCEL_PRINT]
rename_existing: CANCEL_PRINT_BASE
gcode:
  TURN_OFF_HEATERS
  M106 S0
  {% if printer.toolhead.homed_axes == "xyz" %}
    G91
    G1 Z10 F600
    G90
    G1 X0 Y0 F6000
  {% endif %}
  CANCEL_PRINT_BASE
  M117 Print Canceled
[gcode_macro PAUSE]
rename_existing: PAUSE_BASE
gcode:
  PAUSE_BASE
  {% if printer.toolhead.homed_axes == "xyz" %}
    G91
    G1 Z10 F600
    G90
    G1 X{printer.toolhead.axis_maximum.x-5} Y{printer.toolhead.axis_maximum.y-5} F6000
  {% endif %}
  M117 Print Paused
[gcode_macro RESUME]
rename_existing: RESUME_BASE
gcode:
  RESUME_BASE
  M117 Resuming Print

[gcode_macro CHAMBER_SET]
description: Set chamber heater target using watermark control
gcode:
  {% set TARGET = params.TARGET|default(30)|float %}
  SET_HEATER_TEMPERATURE HEATER=chamber TARGET={TARGET}

[gcode_macro CHAMBER_OFF]
description: Turn chamber heater off
gcode:
  SET_HEATER_TEMPERATURE HEATER=chamber TARGET=0
[input_shaper]
shaper_type_x: mzv
shaper_freq_x: 65.6
shaper_type_y: mzv
shaper_freq_y: 61.6
damping_ratio_x: 0.10
damping_ratio_y: 0.10

# ========================================
# ========================================

# Mesh Learning System
[include adaptive_mesh_learning.cfg]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.155725, -0.143225, -0.148225
#*# 	  -0.155725, -0.130725, -0.115725
#*# 	  -0.120725, -0.115725, -0.115725
#*# x_count = 3
#*# y_count = 3
#*# mesh_x_pps = 5
#*# mesh_y_pps = 5
#*# algo = lagrange
#*# tension = 0.035
#*# min_x = 101.0
#*# max_x = 119.0
#*# min_y = 95.0
#*# max_y = 125.0
